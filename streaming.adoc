= Streaming in riff

== Current request-reply model ==

=== Square invocations

.square possible invocations in sequence
[plantuml, format="png"]
----
participant client
box "Pod 1" #LightBlue
	participant invoker
	participant function
end box

== First request-reply ==
client -> invoker : HTTP request [...] 'Host: square.default.example.com' [...] --data 8
activate invoker
invoker -> function : << instanciates function once >>
activate function
invoker -> invoker : unmarshalls request payload
invoker -> function : invoke(fn,8)
function -> invoker : return 64
invoker -> invoker : marshalls response payload
invoker -> client : HTTP response with 64
== Second request-reply before scale-to-0 ==
client -> invoker : HTTP request [...] 'Host: square.default.example.com' [...] --data 8
note right: the request could actually be routed to another pod instance instead or concurrently served to the same pod 
invoker -> invoker : unmarshalls payload
invoker -> function : invoke(fn,8)
function -> invoker : return 64
invoker -> invoker : marshalls response payload
invoker -> client : HTTP response with 64
...scale-to-zero timeout reached...
invoker -> invoker : << shuts down >>
deactivate function
deactivate invoker
----

== Possible gRPC streaming model ==

=== Run-Length Encoding invocations on "AABBBC"

.riff.proto
[source,proto]
----
service Riff {
    rpc Invoke(stream Frame) returns (stream Message) {}
}

message Start {
    string contentType = 1;
    string accept = 2;
}

message Message {
    bytes payload = 1;
    map<string, string> headers = 2;
}

message Frame {
    oneof value {
        Start start = 1;
        Message message = 2;
    }
}
----

."AABBBC" run-length encoding possible invocations in sequence
[plantuml, format="png"]
----
participant grpc_client
box "Pod 1" #LightBlue
	participant invoker
	participant function
end box


grpc_client -> invoker : gRPC call to Invoke with Start payload
activate invoker
invoker -> invoker : unmarshalls Start payload
invoker -> function : << instanciates function >>
activate function
function -> function : << initializes and starts accepting streams >>
function -> invoker : instanciation complete
invoker -> grpc_client : 200 OK response
grpc_client-> invoker : gRPC call to Invoke with Message payload ("A")
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "A")
function -> function : onNext("A")
grpc_client-> invoker : gRPC call to Invoke with Message payload ("A")
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "A")
function -> function : onNext("A")
grpc_client-> invoker : gRPC call to Invoke with Message payload ("B")
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "B")
function -> function : onNext("B")
function -> invoker : return Stream(Tuple("A", 2))
invoker -> invoker : marshalls data stream Protobuf payload
invoker ->  grpc_client : gRPC response Message with ("A", 2)
grpc_client -> invoker : gRPC call to Invoke with Message payload ("B")
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "B")
function -> function : onNext("B")
grpc_client-> invoker : gRPC call to Invoke with Message payload ("B")
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "B")
function -> function : onNext("B")
grpc_client-> invoker : gRPC call to Invoke with Message payload ("C")
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "C")
function -> function : onNext("C")
function -> invoker : return Stream(Tuple("B", 3))
invoker -> invoker : marshalls data stream Protobuf payload
invoker ->  grpc_client : gRPC response Message with ("B", 3)
function -> invoker : return Stream(Tuple("C", 1))
invoker -> invoker : marshalls data stream Protobuf payload
invoker ->  grpc_client : gRPC response Message with ("C", 1)
...scale-to-zero timeout reached...
invoker -> invoker : << shutdown >>
deactivate function
deactivate invoker
----