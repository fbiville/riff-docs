= Streaming in riff

== Current request-reply model ==

.square possible invocations in sequence
[plantuml, format="png"]
----
participant client
participant cluster
box "Pod 1" #LightBlue
	participant invoker
	participant function
end box

== First request-reply ==
client -> cluster : HTTP request [...] 'Host: square.default.example.com' [...] --data 8
cluster -> invoker : << activates pod >>
activate invoker
cluster -> invoker : << routes request >>
invoker -> function : << instanciates function once >>
activate function
invoker -> invoker : unmarshalls request payload
invoker -> function : invoke(fn,8)
function -> invoker : return 64
invoker -> invoker : marshalls response payload
invoker -> client : HTTP response with 64
== Second request-reply before scale-to-0 ==
client -> cluster : `HTTP request [...] 'Host: square.default.example.com' [...] --data 8
cluster -> invoker : << routes request >>
note right: the request could actually be routed to another pod instance instead or concurrently served to the same pod 
invoker -> invoker : unmarshalls payload
invoker -> function : invoke(fn,8)
function -> invoker : return 64
invoker -> invoker : marshalls response payload
invoker -> client : HTTP response with 64
...scale-to-zero timeout reached...
cluster -> invoker : <<scales pod down>>
invoker -> invoker : << shutdown >>
deactivate function
deactivate invoker
----

== Possible gRPC streaming model ==

.riff.proto
[source,proto]
----
service Riff {
    rpc Invoke(stream Frame) returns (stream Message) {}
}

message Start {
    string contentType = 1;
    string accept = 2;
}

message Message {
    bytes payload = 1;
    map<string, string> headers = 2;
}

message Frame {
    oneof value {
        Start start = 1;
        Message message = 2;
    }
}
----

."112221" run-length encoding possible invocations in sequence
[plantuml, format="png"]
----
participant grpc_client
participant cluster
box "Pod 1" #LightBlue
	participant invoker
	participant function
end box


grpc_client -> cluster : gRPC call to Invoke with Start payload
cluster -> invoker : << activates pod >>
activate invoker
cluster -> invoker : << routes request >>
invoker -> invoker : unmarshalls Start payload
invoker -> function : << instanciates function >>
activate function
function -> function : << initializes and starts accepting streams >>
function -> invoker : instanciation complete
invoker -> grpc_client : 200 OK response
grpc_client-> cluster : gRPC call to Invoke with Message payload ("1")
cluster -> invoker : << routes request >>
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "1")
function -> function : onNext("1")
grpc_client-> cluster : gRPC call to Invoke with Message payload ("1")
cluster -> invoker : << routes request >>
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "1")
function -> function : onNext("1")
grpc_client-> cluster : gRPC call to Invoke with Message payload ("2")
cluster -> invoker : << routes request >>
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "2")
function -> function : onNext("2")
function -> invoker : return Stream(Tuple("1", 2))
invoker -> invoker : marshalls data stream Protobuf payload
invoker ->  grpc_client : gRPC response Message with ("1", 2)
grpc_client-> cluster : gRPC call to Invoke with Message payload ("2")
cluster -> invoker : << routes request >>
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "2")
function -> function : onNext("2")
grpc_client-> cluster : gRPC call to Invoke with Message payload ("2")
cluster -> invoker : << routes request >>
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "2")
function -> function : onNext("2")
grpc_client-> cluster : gRPC call to Invoke with Message payload ("1")
cluster -> invoker : << routes request >>
invoker -> invoker : unmarshalls Message payload
invoker -> function : Invoke(fn, "1")
function -> function : onNext("1")
function -> invoker : return Stream(Tuple("2", 3))
invoker -> invoker : marshalls data stream Protobuf payload
invoker ->  grpc_client : gRPC response Message with ("2", 3)
function -> invoker : return Stream(Tuple("1", 1))
invoker -> invoker : marshalls data stream Protobuf payload
invoker ->  grpc_client : gRPC response Message with ("1", 1)
...scale-to-zero timeout reached...
cluster -> invoker : <<scales pod down>>
invoker -> invoker : << shutdown >>
deactivate function
deactivate invoker
----